"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),s={data:()=>({searchText:"",historyList:[],loading:!1}),onLoad(){this.loadHistoryData()},onShow(){this.loadHistoryData()},methods:{async loadHistoryData(){try{this.loading=!0;const t=e.index.getStorageSync("user_openid");t||console.warn("未找到用户openid，将显示所有记录");const s=e.nr.database(),i={fileID:!0,openid:!0,createdAt:!0,"analysis.score":!0,"analysis.scoreTitle":!0,"analysis.scoreDesc":!0,"analysis.nutritionDesc":!0,"analysis.suitablePeople":!0,"analysis.alternativeDesc":!0,"analysis.ingredients":!0};let a;a=t?s.collection("ingredient_analyses").where({openid:t}).field(i).orderBy("createdAt","desc"):s.collection("ingredient_analyses").field(i).orderBy("createdAt","desc");const o=await a.limit(10).get();o&&o.result&&o.result.data&&o.result.data.length>0?(console.log("======第一条数据======",o.result.data[0]),this.historyList=o.result.data.map((e=>{var t;const s=new Date(e.createdAt),i=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")} ${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`,a=(null==(t=e.analysis)?void 0:t.scoreTitle)||"未知产品";return{id:e._id,fileID:e.fileID,name:a,image:e.fileID||"/static/images/placeholder.jpg",date:i,isFavorite:!1,analysis:e.analysis}})),console.log("======转换后的historyList长度======",this.historyList.length),this.checkFavoriteStatus()):(console.warn("======没有查询到数据或数据格式不正确======"),this.historyList=[])}catch(t){console.error("获取历史记录失败:",t),e.index.showToast({title:"获取历史记录失败",icon:"none"}),this.historyList=[]}finally{this.loading=!1}},checkFavoriteStatus(){try{const t=e.index.getStorageSync("favorites")||[];this.historyList.forEach((e=>{const s=t.some((t=>{var s,i;return t.imageId===e.fileID||t.scoreTitle===(null==(s=e.analysis)?void 0:s.scoreTitle)&&""!==(null==(i=e.analysis)?void 0:i.scoreTitle)}));e.isFavorite=s}))}catch(t){console.error("检查收藏状态失败:",t)}},goToCamera(){e.index.navigateTo({url:"/pages/camera/camera"})},goToResult(t){const s={analysis:t.analysis,imageId:t.fileID,analysisId:t.id,isFavorite:t.isFavorite};e.index.setStorageSync("completeAnalysisData",s),e.index.navigateTo({url:"/pages/result/result?from=home"})},toggleFavorite(t){var s,i;try{let a=e.index.getStorageSync("favorites")||[];const o=a.findIndex((e=>{var s,i;return e.imageId===t.fileID||e.scoreTitle===(null==(s=t.analysis)?void 0:s.scoreTitle)&&""!==(null==(i=t.analysis)?void 0:i.scoreTitle)}));if(o>-1)a.splice(o,1),t.isFavorite=!1,e.index.showToast({title:"已取消收藏",icon:"none"});else{const o={imageId:t.fileID,scoreTitle:(null==(s=t.analysis)?void 0:s.scoreTitle)||"",score:(null==(i=t.analysis)?void 0:i.score)||0,timestamp:(new Date).getTime()};a.push(o),t.isFavorite=!0,e.index.showToast({title:"已添加到收藏",icon:"none"})}e.index.setStorageSync("favorites",a)}catch(a){console.error("更新收藏失败:",a),e.index.showToast({title:"操作失败",icon:"none"})}},async deleteHistory(t){e.index.showModal({title:"提示",content:"确定要删除这条记录吗？",success:async s=>{if(s.confirm)try{const s=e.nr.database();await s.collection("ingredient_analyses").doc(t.id).remove();const i=this.historyList.findIndex((e=>e.id===t.id));i>-1&&this.historyList.splice(i,1),e.index.showToast({title:"删除成功",icon:"success"})}catch(i){console.error("删除记录失败:",i),e.index.showToast({title:"删除失败",icon:"none"})}}})},setDefaultImage(e){e.image="/static/images/placeholder.jpg"},getScoreClass:e=>e>=80?"high-score":e>=60?"medium-score":"low-score"}};const i=e._export_sfc(s,[["render",function(s,i,a,o,n,r){return e.e({a:n.searchText,b:e.o((e=>n.searchText=e.detail.value)),c:n.loading},n.loading?{}:0===n.historyList.length?{e:t._imports_0}:{f:e.f(n.historyList,((t,s,i)=>({a:t.image,b:e.o((e=>r.setDefaultImage(t)),s),c:e.t(t.name||"未知产品"),d:e.t(t.date),e:t.isFavorite?1:"",f:e.o((e=>r.toggleFavorite(t)),s),g:e.o((e=>r.deleteHistory(t)),s),h:s,i:e.o((e=>r.goToResult(t)),s)})))},{d:0===n.historyList.length,g:t._imports_1,h:e.o(((...e)=>r.goToCamera&&r.goToCamera(...e)))})}]]);wx.createPage(i);
