"use strict";const e=require("../../common/vendor.js"),o={data:()=>({devicePosition:"back",previewImage:""}),methods:{handleError(o){e.index.showToast({title:"相机启动失败",icon:"none"}),console.error("相机错误：",o)},switchCamera(){this.devicePosition="back"===this.devicePosition?"front":"back"},takePhoto(){e.index.createCameraContext().takePhoto({quality:"high",success:e=>{this.previewImage=e.tempImagePath},fail:o=>{e.index.showToast({title:"拍照失败",icon:"none"}),console.error("拍照错误：",o)}})},chooseImage(){e.index.chooseImage({count:1,success:e=>{this.previewImage=e.tempFilePaths[0]}})},retakePhoto(){this.previewImage=""},confirmPhoto(){e.index.showLoading({title:"正在处理..."});const o=e.index.getStorageSync("user_openid");if(!o)return e.index.hideLoading(),void e.index.showToast({title:"用户身份验证失败",icon:"none"});e.index.compressImage({src:this.previewImage,quality:60,compressedWidth:800,success:t=>{const i=new Date,a=i.getFullYear(),n=String(i.getMonth()+1).padStart(2,"0"),r=i.getTime(),s=Math.floor(1e3*Math.random()),c=`user_images/${o}/${a}/${n}/${r}_${s}.jpg`;let d=null;e.index.showLoading({title:"上传图片中..."}),e.nr.uploadFile({filePath:t.tempFilePath,cloudPath:c,success:t=>{d=t.fileID,e.index.showLoading({title:"正在分析..."}),e.nr.callFunction({name:"imgUploadAndAnalyze",data:{fileID:d,openid:o},success:o=>{if(console.log("分析结果:",o.result),o.result&&0===o.result.code){const t={analysis:o.result.data,imageId:d,analysisId:o.result.analysis_id||"",from:"camera"};e.index.setStorageSync("completeAnalysisData",t)}e.index.hideLoading(),e.index.navigateTo({url:"/pages/result/result?from=camera"})},fail:o=>{console.error("分析配料表失败:",o),e.index.hideLoading(),e.index.showToast({title:"分析失败，请稍后再试",icon:"none",duration:2e3});const t={imageId:d,error:!0,errorMsg:"分析失败，请重试"};e.index.setStorageSync("completeAnalysisData",t),setTimeout((()=>{e.index.navigateTo({url:"/pages/result/result?from=camera&error=true"})}),2e3)}})},fail:o=>{console.error("上传图片失败:",o),e.index.hideLoading(),e.index.showToast({title:"上传图片失败",icon:"none"})}})},fail:o=>{console.error("压缩图片失败:",o),e.index.hideLoading(),e.index.showToast({title:"图片处理失败",icon:"none"})}})}}};const t=e._export_sfc(o,[["render",function(o,t,i,a,n,r){return e.e({a:e.o(((...e)=>r.handleError&&r.handleError(...e))),b:e.o(((...e)=>r.switchCamera&&r.switchCamera(...e))),c:e.o(((...e)=>r.takePhoto&&r.takePhoto(...e))),d:e.o(((...e)=>r.chooseImage&&r.chooseImage(...e))),e:n.previewImage},n.previewImage?{f:n.previewImage,g:e.o(((...e)=>r.retakePhoto&&r.retakePhoto(...e))),h:e.o(((...e)=>r.confirmPhoto&&r.confirmPhoto(...e)))}:{})}]]);wx.createPage(t);
